var WebVttHelper=function(){this.generateVTTCues=function(){var videos=document.getElementsByTagName("video");for(var i=0;i<videos.length;i++){var video=videos[i];var subtitle=document.getElementById(videos[i].dataset.subId);if(!subtitle){continue}var track=video.addTextTrack("subtitles",subtitle.dataset.label,subtitle.dataset.lang);track.mode="showing";var parser=new WebVTTParser;var res=parser.parse(subtitle.innerHTML,"subtitles");res.cues.map(function(cue){var vttcue;try{vttcue=new VTTCue(cue.startTime,cue.endTime,cue.text)}catch(err){if(err.description.indexOf("'VTTCue' is undefined")!==-1||err.description.indexOf("'VTTCue' is not defined")!==-1){vttcue=new TextTrackCue(cue.startTime,cue.endTime,cue.text)}else{throw err}}track.addCue(vttcue)})}}};var WebVTTParser=function(){this.parse=function(input,mode){var NEWLINE=/\r\n|\r|\n/,startTime=Date.now(),linePos=0,lines=input.split(NEWLINE),alreadyCollected=false,cues=[],errors=[];function err(message,col){errors.push({message:message,line:linePos+1,col:col})}var line=lines[linePos],lineLength=line.length,signature="WEBVTT",bom=0,signature_length=signature.length;if(line[0]==="\ufeff"){bom=1;signature_length+=1}if(lineLength<signature_length||line.indexOf(signature)!==0+bom||lineLength>signature_length&&line[signature_length]!==" "&&line[signature_length]!=="\t"){err('No valid signature. (File needs to start with "WEBVTT".)')}linePos++;while(lines[linePos]!=""&&lines[linePos]!=undefined){err("No blank line after the signature.");if(lines[linePos].indexOf("--\x3e")!=-1){alreadyCollected=true;break}linePos++}while(lines[linePos]!=undefined){var cue;while(!alreadyCollected&&lines[linePos]==""){linePos++}if(!alreadyCollected&&lines[linePos]==undefined)break;cue={id:"",startTime:0,endTime:0,pauseOnExit:false,direction:"horizontal",snapToLines:true,linePosition:"auto",textPosition:50,size:100,alignment:"middle",text:"",tree:null};var parseTimings=true;if(lines[linePos].indexOf("--\x3e")==-1){cue.id=lines[linePos];if(/^NOTE($|[ \t])/.test(cue.id)){linePos++;while(lines[linePos]!=""&&lines[linePos]!=undefined){if(lines[linePos].indexOf("--\x3e")!=-1)err("Cannot have timestamp in a comment.");linePos++}continue}linePos++;if(lines[linePos]==""||lines[linePos]==undefined){err("Cue identifier cannot be standalone.");continue}if(lines[linePos].indexOf("--\x3e")==-1){parseTimings=false;err("Cue identifier needs to be followed by timestamp.")}}alreadyCollected=false;var timings=new WebVTTCueTimingsAndSettingsParser(lines[linePos],err);var previousCueStart=0;if(cues.length>0){previousCueStart=cues[cues.length-1].startTime}if(parseTimings&&!timings.parse(cue,previousCueStart)){cue=null;linePos++;while(lines[linePos]!=""&&lines[linePos]!=undefined){if(lines[linePos].indexOf("--\x3e")!=-1){alreadyCollected=true;break}linePos++}continue}linePos++;while(lines[linePos]!=""&&lines[linePos]!=undefined){if(lines[linePos].indexOf("--\x3e")!=-1){err("Blank line missing before cue.");alreadyCollected=true;break}if(cue.text!="")cue.text+="\n";cue.text+=lines[linePos];linePos++}var cuetextparser=new WebVTTCueTextParser(cue.text,err,mode);cue.tree=cuetextparser.parse(cue.startTime,cue.endTime);cues.push(cue)}cues.sort(function(a,b){if(a.startTime<b.startTime)return-1;if(a.startTime>b.startTime)return 1;if(a.endTime>b.endTime)return-1;if(a.endTime<b.endTime)return 1;return 0});return{cues:cues,errors:errors,time:Date.now()-startTime}}};var WebVTTCueTimingsAndSettingsParser=function(line,errorHandler){var SPACE=/[\u0020\t\f]/,NOSPACE=/[^\u0020\t\f]/,line=line,pos=0,err=function(message){errorHandler(message,pos+1)},spaceBeforeSetting=true;function skip(pattern){while(line[pos]!=undefined&&pattern.test(line[pos])){pos++}}function collect(pattern){var str="";while(line[pos]!=undefined&&pattern.test(line[pos])){str+=line[pos];pos++}return str}function timestamp(){var units="minutes",val1,val2,val3,val4;if(line[pos]==undefined){err("No timestamp found.");return}if(!/\d/.test(line[pos])){err("Timestamp must start with a character in the range 0-9.");return}val1=collect(/\d/);if(val1.length>2||parseInt(val1,10)>59){units="hours"}if(line[pos]!=":"){err("No time unit separator found.");return}pos++;val2=collect(/\d/);if(val2.length!=2){err("Must be exactly two digits.");return}if(units=="hours"||line[pos]==":"){if(line[pos]!=":"){err("No seconds found or minutes is greater than 59.");return}pos++;val3=collect(/\d/);if(val3.length!=2){err("Must be exactly two digits.");return}}else{val3=val2;val2=val1;val1="0"}if(line[pos]!="."&&line[pos]!=","){err('No decimal separator (".") found.');return}pos++;val4=collect(/\d/);if(val4.length!=3){err("Milliseconds must be given in three digits.");return}if(parseInt(val2,10)>59){err("You cannot have more than 59 minutes.");return}if(parseInt(val3,10)>59){err("You cannot have more than 59 seconds.");return}return parseInt(val1,10)*60*60+parseInt(val2,10)*60+parseInt(val3,10)+parseInt(val4,10)/1e3}function parseSettings(input,cue){var settings=input.split(SPACE),seen=[];for(var i=0;i<settings.length;i++){if(settings[i]=="")continue;var index=settings[i].indexOf(":"),setting=settings[i].slice(0,index);value=settings[i].slice(index+1);if(seen.indexOf(setting)!=-1){err("Duplicate setting.")}seen.push(setting);if(value==""){err("No value for setting defined.");return}if(setting=="vertical"){if(value!="rl"&&value!="lr"){err("Writing direction can only be set to 'rl' or 'rl'.");continue}cue.direction=value}else if(setting=="line"){if(!/\d/.test(value)){err("Line position takes a number or percentage.");continue}if(value.indexOf("-",1)!=-1){err("Line position can only have '-' at the start.");continue}if(value.indexOf("%")!=-1&&value.indexOf("%")!=value.length-1){err("Line position can only have '%' at the end.");continue}if(value[0]=="-"&&value[value.length-1]=="%"){err("Line position cannot be a negative percentage.");continue}if(value[value.length-1]=="%"){if(parseInt(value,10)>100){err("Line position cannot be >100%.");continue}cue.snapToLines=false}cue.linePosition=parseInt(value,10)}else if(setting=="position"){if(value[value.length-1]!="%"){err("Text position must be a percentage.");continue}if(parseInt(value,10)>100){err("Size cannot be >100%.");continue}cue.textPosition=parseInt(value,10)}else if(setting=="size"){if(value[value.length-1]!="%"){err("Size must be a percentage.");continue}if(parseInt(value,10)>100){err("Size cannot be >100%.");continue}cue.size=parseInt(value,10)}else if(setting=="align"){var alignValues=["start","middle","end","left","right"];if(alignValues.indexOf(value)==-1){err("Alignment can only be set to one of "+alignValues.join(", ")+".");continue}cue.alignment=value}else{err("Invalid setting.")}}}this.parse=function(cue,previousCueStart){skip(SPACE);cue.startTime=timestamp();if(cue.startTime==undefined){return}if(cue.startTime<previousCueStart){err("Start timestamp is not greater than or equal to start timestamp of previous cue.")}if(NOSPACE.test(line[pos])){err("Timestamp not separated from '--\x3e' by whitespace.")}skip(SPACE);if(line[pos]!="-"){err("No valid timestamp separator found.");return}pos++;if(line[pos]!="-"){err("No valid timestamp separator found.");return}pos++;if(line[pos]!=">"){err("No valid timestamp separator found.");return}pos++;if(NOSPACE.test(line[pos])){err("'--\x3e' not separated from timestamp by whitespace.")}skip(SPACE);cue.endTime=timestamp();if(cue.endTime==undefined){return}if(cue.endTime<=cue.startTime){err("End timestamp is not greater than start timestamp.")}if(NOSPACE.test(line[pos])){spaceBeforeSetting=false}skip(SPACE);parseSettings(line.substring(pos),cue);return true};this.parseTimestamp=function(){var ts=timestamp();if(line[pos]!=undefined){err("Timestamp must not have trailing characters.");return}return ts}};var WebVTTCueTextParser=function(line,errorHandler,mode){var line=line,pos=0,err=function(message){if(mode=="metadata")return;errorHandler(message,pos+1)};this.parse=function(cueStart,cueEnd){var result={children:[]},current=result,timestamps=[];function attach(token){current.children.push({type:"object",name:token[1],classes:token[2],children:[],parent:current});current=current.children[current.children.length-1]}function inScope(name){var node=current;while(node){if(node.name==name)return true;node=node.parent}return}while(line[pos]!=undefined){var token=nextToken();if(token[0]=="text"){current.children.push({type:"text",value:token[1],parent:current})}else if(token[0]=="start tag"){if(mode=="chapters")err("Start tags not allowed in chapter title text.");var name=token[1];if(name!="v"&&name!="lang"&&token[3]!=""){err("Only <v> and <lang> can have an annotation.")}if(name=="c"||name=="i"||name=="b"||name=="u"||name=="ruby"){attach(token)}else if(name=="rt"&&current.name=="ruby"){attach(token)}else if(name=="v"){if(inScope("v")){err("<v> cannot be nested inside itself.")}attach(token);current.value=token[3];if(!token[3]){err("<v> requires an annotation.")}}else if(name=="lang"){attach(token);current.value=token[3]}else{err("Incorrect start tag.")}}else if(token[0]=="end tag"){if(mode=="chapters")err("End tags not allowed in chapter title text.");if(token[1]==current.name){current=current.parent}else if(token[1]=="ruby"&&current.name=="rt"){current=current.parent.parent}else{err("Incorrect end tag.")}}else if(token[0]=="timestamp"){if(mode=="chapters")err("Timestamp not allowed in chapter title text.");var timings=new WebVTTCueTimingsAndSettingsParser(token[1],err),timestamp=timings.parseTimestamp();if(timestamp!=undefined){if(timestamp<=cueStart||timestamp>=cueEnd){err("Timestamp must be between start timestamp and end timestamp.")}if(timestamps.length>0&&timestamps[timestamps.length-1]>=timestamp){err("Timestamp must be greater than any previous timestamp.")}current.children.push({type:"timestamp",value:timestamp,parent:current});timestamps.push(timestamp)}}}while(current.parent){if(current.name!="v"){err("Required end tag missing.")}current=current.parent}return result};function nextToken(){var state="data",result="",buffer="",classes=[];while(line[pos-1]!=undefined||pos==0){var c=line[pos];if(state=="data"){if(c=="&"){buffer=c;state="escape"}else if(c=="<"&&result==""){state="tag"}else if(c=="<"||c==undefined){return["text",result]}else{result+=c}}else if(state=="escape"){if(c=="&"){err("Incorrect escape.");result+=buffer;buffer=c}else if(/[abglmnsprt]/.test(c)){buffer+=c}else if(c==";"){if(buffer=="&amp"){result+="&"}else if(buffer=="&lt"){result+="<"}else if(buffer=="&gt"){result+=">"}else if(buffer=="&lrm"){result+="‎"}else if(buffer=="&rlm"){result+="‏"}else if(buffer=="&nbsp"){result+=" "}else{err("Incorrect escape.");result+=buffer+";"}state="data"}else if(c=="<"||c==undefined){err("Incorrect escape.");result+=buffer;return["text",result]}else{err("Incorrect escape.");result+=buffer+c;state="data"}}else if(state=="tag"){if(c=="\t"||c=="\n"||c=="\f"||c==" "){state="start tag annotation"}else if(c=="."){state="start tag class"}else if(c=="/"){state="end tag"}else if(/\d/.test(c)){result=c;state="timestamp tag"}else if(c==">"||c==undefined){if(c==">"){pos++}return["start tag","",[],""]}else{result=c;state="start tag"}}else if(state=="start tag"){if(c=="\t"||c=="\f"||c==" "){state="start tag annotation"}else if(c=="\n"){buffer=c;state="start tag annotation"}else if(c=="."){state="start tag class"}else if(c==">"||c==undefined){if(c==">"){pos++}return["start tag",result,[],""]}else{result+=c}}else if(state=="start tag class"){if(c=="\t"||c=="\f"||c==" "){classes.push(buffer);buffer="";state="start tag annotation"}else if(c=="\n"){classes.push(buffer);buffer=c;state="start tag annotation"}else if(c=="."){classes.push(buffer);buffer=""}else if(c==">"||c==undefined){if(c==">"){pos++}classes.push(buffer);return["start tag",result,classes,""]}else{buffer+=c}}else if(state=="start tag annotation"){if(c==">"||c==undefined){if(c==">"){pos++}buffer=buffer.split(/[\u0020\t\f\r\n]+/).filter(function(item){if(item)return true}).join(" ");return["start tag",result,classes,buffer]}else{buffer+=c}}else if(state=="end tag"){if(c==">"||c==undefined){if(c==">"){pos++}return["end tag",result]}else{result+=c}}else if(state=="timestamp tag"){if(c==">"||c==undefined){if(c==">"){pos++}return["timestamp",result]}else{result+=c}}else{err("Never happens.")}pos++}}};var WebVTTSerializer=function(){function serializeTree(tree){var result="";for(var i=0;i<tree.length;i++){var node=tree[i];if(node.type=="text"){result+=node.value}else if(node.type=="object"){result+="<"+node.name;if(node.classes){for(var y=0;y<node.classes.length;y++){result+="."+node.classes[y]}}if(node.value){result+=" "+node.value}result+=">";if(node.children)result+=serializeTree(node.children);result+="</"+node.name+">"}else{result+="<"+node.value+">"}}return result}function serializeCue(cue){return cue.startTime+" "+cue.endTime+"\n"+serializeTree(cue.tree.children)+"\n\n"}this.serialize=function(cues){var result="";for(var i=0;i<cues.length;i++){result+=serializeCue(cues[i])}return result}};